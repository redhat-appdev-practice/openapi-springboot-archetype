# Spring Service for Feedback360

This repository serves as the backend for the Feedback360 suite of applications.  It implements the OpenAPI specification defined here [Consultant 360 API Specification.](https://gitlab.consulting.redhat.com/appdev-coe/consultant-360-feedback/survey-openapi)

## Working Locally
Because part of the code in this service is generated by the ```openApi-generator```, integrating changes into this repository has a few extra step.  It is important to keep in mind that the code generated by the openApi-generator is not maintained in this repository and should not be checked in.  It is also important to note that the openapi.yml that is used to generate code needs to be in sync with the API specification maintained at [Consultant 360 API Specification.](https://gitlab.consulting.redhat.com/appdev-coe/consultant-360-feedback/survey-openapi).  This means making sure any changes in the parent repository are manually copied to the opneapi.yml file before working locally.  A pull request must be rasied to the [Consultant 360 API Specification.](https://gitlab.consulting.redhat.com/appdev-coe/consultant-360-feedback/survey-openapi) with any changes to the openapi.yml file as a result of new development.


### Step by Step instructions
#### Pulling code and syncing with the latest OpenApi Specification 
Pull down the latest ```survey-openapi-spring-service``` repository
```
git clone https://gitlab.consulting.redhat.com/appdev-coe/consultant-360-feedback/survey-openapi-spring-service.git
git pull origin
```
The ```survey-openapi``` repository is a submodule that houses our OpenApi Specification
```
git submodule update --init
```

#### Compiling, working, and testing
Your ```survey-openapi-spring-serivce``` should now have the latest OpenApi Specification and is ready to compile.
```
mvn clean
mvn compile
```
Running Maven Compile uses the ```openapi-generator``` to create the controllers, models, and configuration needed to run the service in the ```survey-openapi-spring-service/src/gen``` folder.  You should now be able to run the application successfully and make changes as necessary.  

When making changes keep in mind that the code inside the ```survey-openapi-spring-service/src/gen``` is immutable and should not be manually updated.  Any changes you want to see inside the generated code must be handled by making changes to the ```openapi.yml``` file and regenerating the code.  

### Running code locally

To run the entire project please use the `local-dev-bootstrap` project

To run just the backend piece use the following steps:

Postgres DB required to run locally. Can be installed directly or you can use a docker image with the following command:
`sudo docker run -d --name local-postgres -e POSTGRES_PASSWORD=surveydb -e POSTGRES_USER=surveydb -e POSTGRES_DB=surveydb -p "5432:5432" postgres`

Start with the `test` spring profile
`mvn spring-boot:run -Dspring-boot.run.profiles=test"`

*Swagger Page:* http://localhost:8081/swagger-ui.html
*Database Console:* http://localhost:8081/h2-console/

 
#### Pushing code
When you are done making changes and are ready to push, create a pull/merge request to the ```survey-openapi-spring-service``` repository. Again, please keep in mind that code inside  ```survey-openapi-spring-service/src/gen``` folder is generated during compile time and should not be pushed to the repository.  Changes to ```survey-openapi-spring-service/src/main```, ```survey-openapi-spring-service/src/test``` and other configuration are acceptable and can be pushed to the repository.

#### Updating the [Consultant 360 API Specification.](https://gitlab.consulting.redhat.com/appdev-coe/consultant-360-feedback/survey-openapi)
The final step is to make sure any changes you've made to the ```survey-openapi/src/survey-api-2.0.0.yaml``` file are pushed back to the ```survey-openapi``` submodule.
```
$ cd survey-openapi
$ git commit -a -m "commit in survey-openapi"
$ git push
$ cd ..
$ git add survey-openapi
$ git commit -m "Updated submodule"
```

#### Pulling code
When updating the ```survey-openapi-spring-serivce``` repository make sure you include an update of the ```survey-openapi``` submodule by doing the following:
```
git pull --recurse-submodules
```

#### Generating Test Surveys 
Under src/main/resources you will see a Data Generation script (dataGenerator.sh). This script can be used to generate a sample survey for each employee in the system. A survey-group with base skills and 5 other (fake) users will be added for each employee. These surveys should then be available from each user's home screen and all visable through the pm screens.

If you are running locally no changes are necessary.
```
./src/main/resources/dataGenerator.sh
```
If you are running on a remote environment (UAT/DEV) you will need to uncomment the line just below the first declaration of baseURL in the script. The script will then need to be transferred to the spring backend container where you will have to run it. If you would like to run it from another container you will have to altar the baseURL to not use localhost. This script cannot be run from outside the cluster. 
```
oc cp ./src/main/resources/dataGenerator.sh <survey-spring-pod>:/tmp/script/dataGenerator.sh
oc rsh <survey-spring-pod>
/tmp/script/dataGenerator.sh
```
### Database Migrations
Database migrations are managed through liquibase.  Currently, this is accomplished when the service starts via Spring Boot.
See src/main/resources/db/changelog/db.changelog-master.yaml for the current configuration.

#### Adding a new DB Migration
Go to the bottom of the file (src/main/resources/db/changelog/db.changelog-master.yaml) and add your db change.  

As an example, the following changeset will add a constraint to the skills table:
```aidl
- changeSet:
      id: 1595012255439-37
      author: wmckinle
      changes:
          - addUniqueConstraint:
                columnNames: skills_base_id
                constraintName: skills_base_id_unique_constraint
                tableName: skills
          - addNotNullConstraint:
                columnName: skills_base_id
                tableName: skills
                defaultNullValue: -1
```
The important piece in the changeSet above is that the id must be unique.  We have been following a convention of copying the
previous changeSet and modifying the last number (after the -).  This is sufficient to create a unique changeset that can 
be tracked by liquibase.

#### Testing your migration
The easiest way to test your migration is by pulling down a Postgres instance with docker and running it locally.

For example,
```aidl
docker run --name my-postgres \
    -e POSTGRES_USER=surveydb \
    -e POSTGRES_PASSWORD=surveydb \
    -e POSTGRES_DB=consultant360 \
    -p 5432:5432 \
    postgres
```
Once this is up and running, verify that the settings in src/main/resources/liquibase.properties match your local settings.

Run
```aidl
mvn liquibase:update
```

You can login to the console using psql-client to check the data schema.  For example,
```aidl
consultant360=# \d skills
                          Table "public.skills"
     Column     |          Type          | Collation | Nullable | Default 
----------------+------------------------+-----------+----------+---------
 id             | uuid                   |           | not null | 
 active         | boolean                |           |          | 
 category       | character varying(255) |           |          | 
 description    | character varying(512) |           |          | 
 skill          | character varying(255) |           |          | 
 skills_base_id | integer                |           |          | 
Indexes:
    "skills_pkey" PRIMARY KEY, btree (id)
Referenced by:
    TABLE "default_survey_skills" CONSTRAINT "fk1v9ku87x48swjjsydfdpuo1co" FOREIGN KEY (skill_id) REFERENCES skills(id)
    TABLE "skill_rating" CONSTRAINT "fkfurcx3am82bjp4dvq0lx4t5d6" FOREIGN KEY (skill_id) REFERENCES skills(id)

```

#### Testing Rollback
For the most part, liquibase can manage rollbacks automatically.  To verify this after you have tested update, execute 

`mvn liquibase:rollback -Dliquibase.rollbackCount=1`

If all looks good you should be able to commit your changes.

#### Happy Coding!


